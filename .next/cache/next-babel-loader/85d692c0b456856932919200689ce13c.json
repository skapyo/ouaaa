{"ast":null,"code":"import _extends from \"@babel/runtime/helpers/esm/extends\";\nimport _defineProperty from \"@babel/runtime/helpers/esm/defineProperty\";\nimport _slicedToArray from \"@babel/runtime/helpers/esm/slicedToArray\";\n\nvar _this = this,\n    _jsxFileName = \"C:\\\\Users\\\\skaPy\\\\IdeaProjects\\\\Next.js-boilerplate\\\\oozie-client\\\\components\\\\controllers\\\\FormController.tsx\",\n    _s2 = $RefreshSig$();\n\nvar __jsx = React.createElement;\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nimport React from \"react\";\nimport { useCallback, useState, useEffect, useMemo } from \"react\";\nimport { useMutation } from \"@apollo/react-hooks\";\nimport { useSnackbar } from \"notistack\";\nimport omitTypename from \"utils/omitTypename\";\nimport validateEmailFormat from \"utils/validateEmailFormat\";\nimport validatePasswordFormat from \"utils/validatePasswordFormat\";\nexport var ValidationRuleType;\n\n(function (ValidationRuleType) {\n  ValidationRuleType[\"password\"] = \"password\";\n  ValidationRuleType[\"equalTo\"] = \"equalTo\";\n  ValidationRuleType[\"required\"] = \"required\";\n  ValidationRuleType[\"email\"] = \"email\";\n  ValidationRuleType[\"only\"] = \"only\";\n})(ValidationRuleType || (ValidationRuleType = {}));\n\nvar withMutation = function withMutation(FormComponent) {\n  var _s = $RefreshSig$();\n\n  return _s(function (props) {\n    _s();\n\n    var formValues = props.formValues,\n        setFormValue = props.setFormValue,\n        queryOptions = props.queryOptions,\n        setInitialFormValues = props.setInitialFormValues;\n    var scnackbar = useSnackbar();\n\n    var _useMutation = useMutation(queryOptions.query, {\n      variables: {\n        formValues: formValues\n      }\n    }),\n        _useMutation2 = _slicedToArray(_useMutation, 2),\n        update = _useMutation2[0],\n        _useMutation2$ = _useMutation2[1],\n        data = _useMutation2$.data,\n        loading = _useMutation2$.loading,\n        error = _useMutation2$.error;\n\n    var submitHandler = useCallback(function () {\n      update();\n    }, [update]);\n    useEffect(function () {\n      // if (!error) {\n      var next = false;\n\n      if (queryOptions.mutationResultControl == \"builtin\") {\n        if ((data === null || data === void 0 ? void 0 : data[queryOptions.resultLabel]) && !error) next = true;\n      } else if (queryOptions.mutationResultControl && queryOptions.mutationResultControl(formValues, data, error)) next = true;\n\n      if (next) {\n        setInitialFormValues(omitTypename(data === null || data === void 0 ? void 0 : data[queryOptions.resultLabel]));\n        if (queryOptions.snackbarSucceedMessage) scnackbar.enqueueSnackbar(queryOptions.snackbarSucceedMessage);\n        if (queryOptions.afterResultControlCallback) queryOptions.afterResultControlCallback(formValues, data, error);\n\n        if (queryOptions.clearFormvaluesAfterControl) {\n          var keys = Object.keys(formValues);\n          var formValuesTemp = {};\n          keys.forEach(function (key) {\n            formValuesTemp = _objectSpread(_objectSpread({}, formValuesTemp), {}, _defineProperty({}, key, \"\"));\n          });\n          setFormValue(formValuesTemp);\n        }\n      } else if (data) throw new Error(\"No data for the result label: \".concat(queryOptions.resultLabel)); // }\n\n    }, [data, error]);\n    return __jsx(FormComponent, _extends({}, props, {\n      submitHandler: submitHandler,\n      loading: loading,\n      __self: _this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 143,\n        columnNumber: 5\n      }\n    }));\n  }, \"o/YTkBntrUDZmN1ABs6M8b9ACVA=\", false, function () {\n    return [useSnackbar, useMutation];\n  });\n};\n\nvar FormController = function FormController(props) {\n  _s2();\n\n  for (var _len = arguments.length, otherprops = new Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {\n    otherprops[_key - 1] = arguments[_key];\n  }\n\n  var initValues = props.initValues,\n      render = props.render,\n      _props$withQuery = props.withQuery,\n      withQuery = _props$withQuery === void 0 ? false : _props$withQuery,\n      queryOptions = props.queryOptions,\n      _props$validationRule = props.validationRules,\n      validationRules = _props$validationRule === void 0 ? null : _props$validationRule;\n\n  var _useState = useState(_objectSpread({}, initValues)),\n      formValues = _useState[0],\n      setFormValue = _useState[1];\n\n  var _useState2 = useState(_objectSpread({}, initValues)),\n      initialFormValues = _useState2[0],\n      setInitialFormValues = _useState2[1];\n\n  var _useState3 = useState(),\n      validationResult = _useState3[0],\n      setValidationResult = _useState3[1];\n\n  var formChangeHandler = useCallback(function (e) {\n    // if there an only rule on the field\n    var rule = validationRules === null || validationRules === void 0 ? void 0 : validationRules[e.target.name];\n\n    if ((rule === null || rule === void 0 ? void 0 : rule.rule) === ValidationRuleType.only) {\n      if (rule.type === \"number\") {\n        var isnum = /^\\d+$/.test(e.target.value);\n        if (isnum) setFormValue(_objectSpread(_objectSpread({}, formValues), {}, _defineProperty({}, e.target.name, e.target.value)));\n      }\n\n      if (rule.type === \"string\") {\n        var ischar = /^[a-zA-Z]+$/.test(e.target.value);\n        if (ischar) setFormValue(_objectSpread(_objectSpread({}, formValues), {}, _defineProperty({}, e.target.name, e.target.value)));\n      }\n    } else {\n      setFormValue(_objectSpread(_objectSpread({}, formValues), {}, _defineProperty({}, e.target.name, e.target.value)));\n    }\n  }, [setFormValue, formValues, validationRules]);\n  /* a revoir */\n\n  var isModified = useMemo(function () {\n    if (JSON.stringify(formValues) == JSON.stringify(initialFormValues)) return false;\n    return true;\n  }, [formValues, initialFormValues]);\n  var clearFormvalues = useCallback(function () {\n    setFormValue({});\n    setInitialFormValues({});\n  }, [setFormValue]);\n  /* validation : a revoir / compléter .. */\n\n  useEffect(function () {\n    if (validationRules) {\n      var validationResultTemp = {\n        global: true,\n        result: {}\n      };\n      var keys = Object.keys(validationRules);\n      keys.forEach(function (key) {\n        var field = validationRules[key];\n        /* password rule handler */\n\n        if (field.rule == ValidationRuleType.password) {\n          var result = validatePasswordFormat(formValues === null || formValues === void 0 ? void 0 : formValues[key]);\n          /* if the password format is validated, update the result for the concerned field */\n\n          if (result.length !== 0) {\n            var newKeyValue = validationResultTemp.result[key] ? validationResultTemp.result[key].concat(result) : result;\n            validationResultTemp = {\n              result: _objectSpread(_objectSpread({}, validationResultTemp.result), {}, _defineProperty({}, key, newKeyValue)),\n              global: false\n            };\n          }\n        }\n        /* equalTo rule handler */\n\n\n        if (field.rule == ValidationRuleType.equalTo) {\n          /* test if the 2 fields are equals */\n          var _result = formValues[key] == formValues[field.field];\n          /* if the test result is false, update the result for the concerned field */\n\n\n          if (!_result) {\n            var _newKeyValue = validationResultTemp.result[key] ? validationResultTemp.result[key].concat(\"equalTo\") : [\"equalTo\"];\n\n            validationResultTemp = {\n              result: _objectSpread(_objectSpread({}, validationResultTemp.result), {}, _defineProperty({}, key, _newKeyValue)),\n              global: false\n            };\n          }\n        }\n        /* required rule handler */\n\n\n        if (field.rule == ValidationRuleType.required) {\n          var _formValues$key;\n\n          /* test if there is a value in the formValues array */\n          var _result2 = ((_formValues$key = formValues[key]) === null || _formValues$key === void 0 ? void 0 : _formValues$key.length) == 0;\n          /* if the test result is true, update the result for the concerned field */\n\n\n          if (_result2) {\n            var _newKeyValue2 = validationResultTemp.result[key] ? validationResultTemp.result[key].concat(\"required\") : [\"required\"];\n\n            validationResultTemp = {\n              result: _objectSpread(_objectSpread({}, validationResultTemp.result), {}, _defineProperty({}, key, _newKeyValue2)),\n              global: false\n            };\n          }\n        }\n        /* email rule handler */\n\n\n        if (field.rule == ValidationRuleType.email) {\n          var _result3 = validateEmailFormat(formValues === null || formValues === void 0 ? void 0 : formValues[key]);\n          /* if the email format is validated, update the result for the concerned field */\n\n\n          if (!_result3) {\n            var _newKeyValue3 = validationResultTemp.result[key] ? validationResultTemp.result[key].concat(\"email\") : [\"email\"];\n\n            validationResultTemp = {\n              result: _objectSpread(_objectSpread({}, validationResultTemp.result), {}, _defineProperty({}, key, _newKeyValue3)),\n              global: false\n            };\n          }\n        }\n      });\n      setValidationResult(validationResultTemp);\n    }\n  }, [formValues, validationRules]);\n  var withMutationProps = useMemo(function () {\n    return {\n      formChangeHandler: formChangeHandler,\n      isModified: isModified,\n      formValues: formValues,\n      validationResult: validationResult,\n      queryOptions: queryOptions,\n      setInitialFormValues: setInitialFormValues,\n      setFormValue: setFormValue,\n      clearFormvalues: clearFormvalues\n    };\n  }, [formChangeHandler, isModified, formValues, validationResult, queryOptions, withQuery, setInitialFormValues, setFormValue]);\n  var renderProps = useMemo(function () {\n    return _objectSpread({\n      formChangeHandler: formChangeHandler,\n      isModified: isModified,\n      formValues: formValues,\n      validationResult: validationResult,\n      clearFormvalues: clearFormvalues\n    }, otherprops);\n  }, [formChangeHandler, isModified, formValues, validationResult // queryOptions,\n  ]);\n\n  if (withQuery) {\n    if (!queryOptions) throw new Error(\"queryOption prop must be provided when withQuery prop is true.\"); // @ts-ignore\n\n    return withMutation(render)(withMutationProps);\n  }\n\n  return render(renderProps);\n};\n\n_s2(FormController, \"KviRedqNgwr3mVg3wTV6B7GCqVw=\");\n\n_c = FormController;\nexport default FormController;\n\nvar _c;\n\n$RefreshReg$(_c, \"FormController\");","map":{"version":3,"sources":["C:/Users/skaPy/IdeaProjects/Next.js-boilerplate/oozie-client/components/controllers/FormController.tsx"],"names":["React","useCallback","useState","useEffect","useMemo","useMutation","useSnackbar","omitTypename","validateEmailFormat","validatePasswordFormat","ValidationRuleType","withMutation","FormComponent","props","formValues","setFormValue","queryOptions","setInitialFormValues","scnackbar","query","variables","update","data","loading","error","submitHandler","next","mutationResultControl","resultLabel","snackbarSucceedMessage","enqueueSnackbar","afterResultControlCallback","clearFormvaluesAfterControl","keys","Object","formValuesTemp","forEach","key","Error","FormController","otherprops","initValues","render","withQuery","validationRules","initialFormValues","validationResult","setValidationResult","formChangeHandler","e","rule","target","name","only","type","isnum","test","value","ischar","isModified","JSON","stringify","clearFormvalues","validationResultTemp","global","result","field","password","length","newKeyValue","concat","equalTo","required","email","withMutationProps","renderProps"],"mappings":"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","sourcesContent":["import React, { ChangeEvent } from \"react\"\r\nimport { useCallback, useState, useEffect, useMemo } from \"react\"\r\nimport { useMutation } from \"@apollo/react-hooks\"\r\nimport { useSnackbar } from \"notistack\"\r\nimport omitTypename from \"utils/omitTypename\"\r\nimport validateEmailFormat from \"utils/validateEmailFormat\"\r\nimport validatePasswordFormat from \"utils/validatePasswordFormat\"\r\nimport { DocumentNode } from \"graphql\"\r\n\r\ntype FormValues = { [key: string]: string }\r\n\r\nexport type QueryOptions = {\r\n  query: DocumentNode\r\n  resultLabel: string\r\n  mutationResultControl?:\r\n    | ((formValues: FormValues, data: any, error: any) => boolean)\r\n    | \"builtin\"\r\n  clearFormvaluesAfterControl?: boolean\r\n  afterResultControlCallback?: (\r\n    formValues: FormValues,\r\n    data: any,\r\n    error: any\r\n  ) => void\r\n  snackbarSucceedMessage?: string\r\n}\r\n\r\nexport enum ValidationRuleType {\r\n  password = \"password\",\r\n  equalTo = \"equalTo\",\r\n  required = \"required\",\r\n  email = \"email\",\r\n  only = \"only\",\r\n}\r\n\r\ntype Rule =\r\n  | {\r\n      rule: ValidationRuleType.password\r\n    }\r\n  | {\r\n      rule: ValidationRuleType.equalTo\r\n      field: string\r\n    }\r\n  | {\r\n      rule: ValidationRuleType.required\r\n    }\r\n  | {\r\n      rule: ValidationRuleType.email\r\n    }\r\n  | {\r\n      rule: ValidationRuleType.only\r\n      type: \"number\" | \"string\"\r\n    }\r\n\r\nexport type ValidationRules = { [key: string]: Rule }\r\n\r\ntype ValidationResult = {\r\n  result: { [key: string]: string[] }\r\n  global: boolean\r\n}\r\n\r\ntype WithMutationProps = {\r\n  formValues: FormValues\r\n  formChangeHandler: (event: ChangeEvent) => void\r\n  validationResult?: ValidationResult\r\n  setFormValue: (formValues: FormValues) => void\r\n  queryOptions: QueryOptions\r\n  setInitialFormValues: (formValues: FormValues) => void\r\n  clearFormvalues: () => void\r\n}\r\n\r\ntype RenderCallbackProps = {\r\n  formValues: FormValues\r\n  formChangeHandler: (event: ChangeEvent) => void\r\n  clearFormvalues: () => void\r\n  validationResult?: ValidationResult\r\n  submitHandler?: () => void\r\n  loading?: boolean\r\n  isModified?: boolean\r\n}\r\n\r\nexport type RenderCallback = (props: RenderCallbackProps) => JSX.Element\r\n\r\ntype FormControllerProps = {\r\n  initValues?: FormValues\r\n  render: RenderCallback\r\n  withQuery?: boolean\r\n  queryOptions?: QueryOptions\r\n  validationRules?: ValidationRules\r\n}\r\n\r\nconst withMutation = (FormComponent: RenderCallback) => (\r\n  props: WithMutationProps\r\n) => {\r\n  const { formValues, setFormValue, queryOptions, setInitialFormValues } = props\r\n  const scnackbar = useSnackbar()\r\n\r\n  const [update, { data, loading, error }] = useMutation(queryOptions.query, {\r\n    variables: {\r\n      formValues,\r\n    },\r\n  })\r\n\r\n  const submitHandler = useCallback(() => {\r\n    update()\r\n  }, [update])\r\n\r\n  useEffect(() => {\r\n    // if (!error) {\r\n    let next = false\r\n    if (queryOptions.mutationResultControl == \"builtin\") {\r\n      if (data?.[queryOptions.resultLabel] && !error) next = true\r\n    } else if (\r\n      queryOptions.mutationResultControl &&\r\n      queryOptions.mutationResultControl(formValues, data, error)\r\n    )\r\n      next = true\r\n\r\n    if (next) {\r\n      setInitialFormValues(omitTypename(data?.[queryOptions.resultLabel]))\r\n\r\n      if (queryOptions.snackbarSucceedMessage)\r\n        scnackbar.enqueueSnackbar(queryOptions.snackbarSucceedMessage)\r\n\r\n      if (queryOptions.afterResultControlCallback)\r\n        queryOptions.afterResultControlCallback(formValues, data, error)\r\n\r\n      if (queryOptions.clearFormvaluesAfterControl) {\r\n        const keys = Object.keys(formValues)\r\n        let formValuesTemp = {}\r\n        keys.forEach((key) => {\r\n          formValuesTemp = { ...formValuesTemp, [key]: \"\" }\r\n        })\r\n        setFormValue(formValuesTemp)\r\n      }\r\n    } else if (data)\r\n      throw new Error(\r\n        `No data for the result label: ${queryOptions.resultLabel}`\r\n      )\r\n    // }\r\n  }, [data, error])\r\n\r\n  return (\r\n    <FormComponent {...props} submitHandler={submitHandler} loading={loading} />\r\n  )\r\n}\r\n\r\nconst FormController = (props: FormControllerProps, ...otherprops: any[]) => {\r\n  const {\r\n    initValues,\r\n    render,\r\n    withQuery = false,\r\n    queryOptions,\r\n    validationRules = null,\r\n  } = props\r\n\r\n  const [formValues, setFormValue] = useState({ ...initValues })\r\n  const [initialFormValues, setInitialFormValues] = useState({ ...initValues })\r\n  const [validationResult, setValidationResult] = useState<ValidationResult>()\r\n\r\n  const formChangeHandler = useCallback(\r\n    (e) => {\r\n      // if there an only rule on the field\r\n      const rule = validationRules?.[e.target.name]\r\n      if (rule?.rule === ValidationRuleType.only) {\r\n        if (rule.type === \"number\") {\r\n          const isnum = /^\\d+$/.test(e.target.value)\r\n\r\n          if (isnum)\r\n            setFormValue({ ...formValues, [e.target.name]: e.target.value })\r\n        }\r\n        if (rule.type === \"string\") {\r\n          const ischar = /^[a-zA-Z]+$/.test(e.target.value)\r\n          if (ischar)\r\n            setFormValue({ ...formValues, [e.target.name]: e.target.value })\r\n        }\r\n      } else {\r\n        setFormValue({ ...formValues, [e.target.name]: e.target.value })\r\n      }\r\n    },\r\n    [setFormValue, formValues, validationRules]\r\n  )\r\n\r\n  /* a revoir */\r\n  const isModified = useMemo(() => {\r\n    if (JSON.stringify(formValues) == JSON.stringify(initialFormValues))\r\n      return false\r\n    return true\r\n  }, [formValues, initialFormValues])\r\n\r\n  const clearFormvalues = useCallback(() => {\r\n    setFormValue({})\r\n    setInitialFormValues({})\r\n  }, [setFormValue])\r\n\r\n  /* validation : a revoir / compléter .. */\r\n  useEffect(() => {\r\n    if (validationRules) {\r\n      let validationResultTemp: ValidationResult = { global: true, result: {} }\r\n\r\n      const keys = Object.keys(validationRules)\r\n\r\n      keys.forEach((key) => {\r\n        const field = validationRules[key]\r\n\r\n        /* password rule handler */\r\n        if (field.rule == ValidationRuleType.password) {\r\n          const result = validatePasswordFormat(formValues?.[key])\r\n\r\n          /* if the password format is validated, update the result for the concerned field */\r\n          if (result.length !== 0) {\r\n            const newKeyValue = validationResultTemp.result[key]\r\n              ? validationResultTemp.result[key].concat(result)\r\n              : result\r\n            validationResultTemp = {\r\n              result: {\r\n                ...validationResultTemp.result,\r\n                [key]: newKeyValue,\r\n              },\r\n              global: false,\r\n            }\r\n          }\r\n        }\r\n\r\n        /* equalTo rule handler */\r\n        if (field.rule == ValidationRuleType.equalTo) {\r\n          /* test if the 2 fields are equals */\r\n          const result = formValues[key] == formValues[field.field]\r\n\r\n          /* if the test result is false, update the result for the concerned field */\r\n          if (!result) {\r\n            const newKeyValue = validationResultTemp.result[key]\r\n              ? validationResultTemp.result[key].concat(\"equalTo\")\r\n              : [\"equalTo\"]\r\n            validationResultTemp = {\r\n              result: {\r\n                ...validationResultTemp.result,\r\n                [key]: newKeyValue,\r\n              },\r\n              global: false,\r\n            }\r\n          }\r\n        }\r\n\r\n        /* required rule handler */\r\n        if (field.rule == ValidationRuleType.required) {\r\n          /* test if there is a value in the formValues array */\r\n          const result = formValues[key]?.length == 0\r\n\r\n          /* if the test result is true, update the result for the concerned field */\r\n          if (result) {\r\n            const newKeyValue = validationResultTemp.result[key]\r\n              ? validationResultTemp.result[key].concat(\"required\")\r\n              : [\"required\"]\r\n            validationResultTemp = {\r\n              result: {\r\n                ...validationResultTemp.result,\r\n                [key]: newKeyValue,\r\n              },\r\n              global: false,\r\n            }\r\n          }\r\n        }\r\n\r\n        /* email rule handler */\r\n        if (field.rule == ValidationRuleType.email) {\r\n          const result = validateEmailFormat(formValues?.[key])\r\n\r\n          /* if the email format is validated, update the result for the concerned field */\r\n          if (!result) {\r\n            const newKeyValue = validationResultTemp.result[key]\r\n              ? validationResultTemp.result[key].concat(\"email\")\r\n              : [\"email\"]\r\n            validationResultTemp = {\r\n              result: {\r\n                ...validationResultTemp.result,\r\n                [key]: newKeyValue,\r\n              },\r\n              global: false,\r\n            }\r\n          }\r\n        }\r\n      })\r\n\r\n      setValidationResult(validationResultTemp)\r\n    }\r\n  }, [formValues, validationRules])\r\n\r\n  const withMutationProps = useMemo(() => {\r\n    return {\r\n      formChangeHandler: formChangeHandler,\r\n      isModified,\r\n      formValues,\r\n      validationResult,\r\n      queryOptions,\r\n      setInitialFormValues,\r\n      setFormValue,\r\n      clearFormvalues,\r\n    }\r\n  }, [\r\n    formChangeHandler,\r\n    isModified,\r\n    formValues,\r\n    validationResult,\r\n    queryOptions,\r\n    withQuery,\r\n    setInitialFormValues,\r\n    setFormValue,\r\n  ])\r\n\r\n  const renderProps = useMemo(() => {\r\n    return {\r\n      formChangeHandler: formChangeHandler,\r\n      isModified,\r\n      formValues,\r\n      validationResult,\r\n      clearFormvalues,\r\n      ...otherprops,\r\n      // queryOptions: queryOptions,\r\n    }\r\n  }, [\r\n    formChangeHandler,\r\n    isModified,\r\n    formValues,\r\n    validationResult,\r\n    // queryOptions,\r\n  ])\r\n\r\n  if (withQuery) {\r\n    if (!queryOptions)\r\n      throw new Error(\r\n        \"queryOption prop must be provided when withQuery prop is true.\"\r\n      )\r\n    // @ts-ignore\r\n    return withMutation(render)(withMutationProps)\r\n  }\r\n\r\n  return render(renderProps)\r\n}\r\n\r\nexport default FormController\r\n"]},"metadata":{},"sourceType":"module"}